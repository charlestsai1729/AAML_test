
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lab5: Get It Together &#8212; CSIC30066: Accelerator Architectures for Machine Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'labs/lab 5';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Lab4: im2col" href="lab%204.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">CSIC30066: Accelerator Architectures for Machine Learning</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Class:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../class/staff.html">Staff</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lab%201.html">Lab1: CFU-Playground Environment Setup &amp; Porting KWS model</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab%202.html">Lab2: SIMD and Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab%203.html">Lab3: Systolic array</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab%204.html">Lab4: im2col</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab5: Get It Together</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/labs/lab 5.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab5: Get It Together</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-this-lab">Goals of this lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intended-learning-outcomes">Intended Learning Outcomes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cfu-cpu-communication">cfu-cpu communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-define-cfu-op">how to define cfu_op</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-to-devise">where to devise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#your-assignment">Your Assignment</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implement">Implement</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze">Analyze</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#debug">debug</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="lab5-get-it-together">
<h1>Lab5: Get It Together<a class="headerlink" href="#lab5-get-it-together" title="Link to this heading">#</a></h1>
<section id="goals-of-this-lab">
<h2>Goals of this lab<a class="headerlink" href="#goals-of-this-lab" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#implement">Implement-80%</a></p></li>
<li><p><a class="reference external" href="#results">Results-10%</a></p></li>
<li><p><a class="reference external" href="#analyze">Analyze-10%</a></p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>After we finished the Lab3, the implementation of Systolic Array, we
want to use it to run an actual Machine Learning Model to let you
understand the true bottleneck when you are designing a Chip to
accelerate your workloads. And the Lab3 focuses on the compute unit, and
in this lab, you will need to understand how software can use the chip
you designed and accelerate the matrix multiply or even any operator
that is a heavy burden on the CPU.</p>
<p>From the class, you’ve learned the Von Neumann Architecture which is
inefficient on compute-intensive workloads, such as matrix multiply,
Convolution, Weather simulation, and also the most popular application,
Computer Vision. And this is just a theory that you’ve learned that you
need to increase the opportunity of data reuse and decrease the data
movement. This is the best chance to let you truly understand how to
improve the workloads.</p>
<p>Before diving into the Lab, you need to understand the following
concept.</p>
<ol class="arabic simple">
<li><p>How does a CPU offload the tasks to the Accelerator?</p></li>
<li><p>How to fully utilize PEs on the accelerator.</p></li>
</ol>
</section>
<section id="intended-learning-outcomes">
<h2>Intended Learning Outcomes<a class="headerlink" href="#intended-learning-outcomes" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Understanding the architecture of cpu and cfu,and how they
communicate with each other.</p></li>
<li><p>Adding the systolic array architecture within the cfu-playgrond.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>The matrix data needs to be transmitted from the CPU to the global
buffers A and B in the CFU. Once all the required data has been
gathered, then the TPU will start to compute this matrix data. The
outcome of the computation will be preserved in the buffer C. Finally,
the data stored in the buffer C will be written back to the CPU.</p>
<img alt="https://hackmd.io/_uploads/Sk2gIodza.jpg" src="https://hackmd.io/_uploads/Sk2gIodza.jpg" />
<section id="cfu-cpu-communication">
<h3>cfu-cpu communication<a class="headerlink" href="#cfu-cpu-communication" title="Link to this heading">#</a></h3>
<p>The “CFU bus” provides the communication between the CPU and CFU. The
CFU Bus is composed of two independent streams:</p>
<ul class="simple">
<li><p>The CPU uses the command stream (cmd) to send operands and 10 bits of
function code to the CFU, thus initiating the CFU computation.</p></li>
<li><p>The CFU uses the response stream (rsp) to return the result to the
CPU. Since the responses are not tagged, they must be delivered
in-order.</p></li>
</ul>
<p>Each stream has two-way handshaking and backpressure (*_valid and
*_ready in the diagram below). An endpoint can indicate that it cannot
accept another transfer by pulling its ready signal low. A transfer
takes place only when both valid from the sender and ready from the
receiver are high.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>he data values from the CPU (cmd_function_id, cmd_inputs_0,
and cmd_inputs_1) are valid ONLY during the cycle that the handshake
is active (when both cmd_valid and cmd_ready are asserted). If your
CFU needs to use these values in subsequent cycles, it must store
them in registers.</p>
</div>
<img alt="../_images/rJ4Or83A3.png" src="../_images/rJ4Or83A3.png" />
<img alt="../_images/r1T4UwpRh.png" src="../_images/r1T4UwpRh.png" />
<p><a class="reference external" href="https://cfu-playground.readthedocs.io/en/latest/step-by-step.html">soucefrom</a></p>
</section>
<section id="how-to-define-cfu-op">
<h3>how to define cfu_op<a class="headerlink" href="#how-to-define-cfu-op" title="Link to this heading">#</a></h3>
<img alt="../_images/BkjuuUnC2.png" src="../_images/BkjuuUnC2.png" />
<p><code class="docutils literal notranslate"><span class="pre">CFU-Playground/common/src/cfu.h</span></code> Here defines cfu_op,
the interface between cfu and cpu by</p>
<ol class="arabic simple">
<li><p>cmd_function_id[ 9:0 ]</p></li>
<li><p>cmd_inputs_0[ 31:0 ]</p></li>
<li><p>cmd_inputs_1[ 31:0 ]</p></li>
<li><p>rsp_outputs_0[ 31:0 ]</p></li>
</ol>
<ul class="simple">
<li><p>cmd_function_id[ 2:0 ] and cmd_function_id[ 9:3 ] corresponding to funct3,funct7 respectively.</p></li>
<li><p>cmd_inputs_0,1 corresponding to rs1,rs2 respectively.</p></li>
<li><p>rsp_outputs_0 is the return value of cfu_op</p></li>
</ul>
</section>
<section id="where-to-devise">
<h3>where to devise<a class="headerlink" href="#where-to-devise" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">CFU-Playground/proj/&quot;your</span> <span class="pre">project&quot;/src/tensorflow/lite/kernels/internal/reference/integer_ops/conv.h</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">CFU-Playground/proj/&quot;your</span> <span class="pre">project</span> <span class="pre">name&quot;/cfu.v</span></code></p>
</section>
<section id="your-assignment">
<h3>Your Assignment<a class="headerlink" href="#your-assignment" title="Link to this heading">#</a></h3>
<section id="implement">
<h4>Implement<a class="headerlink" href="#implement" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Objective :</p>
<ul>
<li><p>Implementing a systolic array to accelerate convolution
operations.</p></li>
</ul>
</li>
<li><p>Input :</p>
<ul>
<li><p>2-D Matrix from Im2Col</p></li>
</ul>
</li>
<li><p>Output :</p>
<ul>
<li><p>The result computed from the systolic array in the CFU</p></li>
</ul>
</li>
</ul>
</section>
<section id="results">
<h4>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Show the results of the labels of KWS model after quantized ,and see
if they match those of lab2.</p></li>
</ul>
<img alt="../_images/H1QUcXCWa.png" src="../_images/H1QUcXCWa.png" />
</section>
<section id="analyze">
<h4>Analyze<a class="headerlink" href="#analyze" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>please compare the total cycles to the results of lab1 and lab2 and
analyze it</p></li>
</ul>
</section>
<section id="debug">
<h4>debug<a class="headerlink" href="#debug" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">CFU-Playground/proj/&quot;your</span> <span class="pre">project</span> <span class="pre">name&quot;/src/proj_menu.cc</span></code> You can
add a new function here, and then run “make PLATFORM=sim load,” select
“t-&gt;3-&gt;function you defined,” and this will generate a waveform (.vcd)
file stored in soc/build/sim.xxx/gateware/sim.vcd .</p>
</section>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lab%204.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab4: im2col</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-of-this-lab">Goals of this lab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intended-learning-outcomes">Intended Learning Outcomes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cfu-cpu-communication">cfu-cpu communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-define-cfu-op">how to define cfu_op</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-to-devise">where to devise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#your-assignment">Your Assignment</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implement">Implement</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze">Analyze</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#debug">debug</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By  NYCU CAS-Lab
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, NYCU CAS-Lab.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>